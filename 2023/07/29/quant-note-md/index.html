<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>é‡åŒ–ç¬”è®° | å°åœ†çš„è§’è½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æœ¬æ–‡ä»‹ç»é‡åŒ–çš„ç›¸å…³çš„çŸ¥è¯†">
<meta property="og:type" content="article">
<meta property="og:title" content="é‡åŒ–ç¬”è®°">
<meta property="og:url" content="http://licharyuan.github.io/2023/07/29/quant-note-md/index.html">
<meta property="og:site_name" content="å°åœ†çš„è§’è½">
<meta property="og:description" content="æœ¬æ–‡ä»‹ç»é‡åŒ–çš„ç›¸å…³çš„çŸ¥è¯†">
<meta property="og:locale">
<meta property="article:published_time" content="2023-07-29T09:09:03.000Z">
<meta property="article:modified_time" content="2023-07-29T09:10:55.031Z">
<meta property="article:author" content="lichar">
<meta name="twitter:card" content="summary">
  
  
    <link href="http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700|Ubuntu:400,700,400italic" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">å°åœ†çš„è§’è½</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">å¥½ä¹æ— è’ è‰¯å£«ä¼‘ä¼‘</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">ä¸»é¡µ</a>
        
          <a class="main-nav-link" href="/about">å…³äº</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-github-link" class="nav-icon" href="https://github.com/LicharYuan" target="_blank"></a>
        
        
        
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://licharyuan.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-quant-note-md" class="article article-type-post" itemscope
  itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/07/29/quant-note-md/" class="article-date">
  <time datetime="2023-07-29T09:09:03.000Z" itemprop="datePublished">2023-07-29</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 class="article-title" itemprop="name">
      é‡åŒ–ç¬”è®°
    </h1>
  

        </header>
        
          <div class="article-entry" itemprop="articleBody">
            
                      <!-- 
    <div id="toc">
        <strong class="sidebar-title"></strong>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">åŸºç¡€éƒ¨åˆ† ğŸ”—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">é‡åŒ–åˆ†ç±» ğŸ”—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">PTQ ğŸ”—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">å’Œè®¡ç®—å›¾ ğŸ”—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">å’ŒLLM ğŸ”—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">QAT çš„ä¸€äº›è¿›å±• ğŸ”—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text"> ğŸ”—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">å‚è€ƒ ğŸ”—</span></a></li></ol>
    </div>
     -->
                      <p>æœ¬æ–‡ä»‹ç»é‡åŒ–çš„ç›¸å…³çš„çŸ¥è¯†</p>
<span id="more"></span>

<h2><span id="åŸºç¡€éƒ¨åˆ†">åŸºç¡€éƒ¨åˆ†</span><a href="#åŸºç¡€éƒ¨åˆ†" class="header-anchor"> ğŸ”—</a></h2><p>é‡åŒ–åè¡¨ç¤ºèŒƒå›´æœ‰é™ï¼Œè¾“å…¥çš„éœ€è¦è¢« <code>clamp</code>.  æˆ‘ä»¬å®šä¹‰ï¼Œquantize çš„è¿‡ç¨‹ä¸º floatæ•°æ®ç±»å‹çš„æ•°æ®è½¬æ¢åˆ°int8 æ•°æ®ç±»å‹å«åš Q è¿‡ç¨‹ï¼Œ DQåˆ™æ˜¯ int8-&gt; float.</p>
<p>å¯¹äºè¾“å…¥ä¸º$x$, int8çš„å®šç‚¹åŒºé—´ä¸º $[q_{min}, q_{max}]$ æ—¶</p>
<ul>
<li>Qè¿‡ç¨‹: $x_Q &#x3D; clamp(q_{min}, q_{max} ,round(x &#x2F; scale) + zp$ </li>
<li>DQè¿‡ç¨‹: $x_{DQ} &#x3D; (X_Q - zero-point) * scale $</li>
</ul>
<p>è¿™ä¸ªè¿‡ç¨‹çš„ä¿¡æ¯æ˜¯æœ‰æŸå¤±çš„ï¼ŒæŸå¤±ç¨‹åº¦å’Œé‡åŒ–è¿‡ç¨‹çš„å‚æ•°æœ‰å…³ $(scale, zp (zero-point), q_{min}, q_{max}$) æœ‰å…³ã€‚  </p>
<ul>
<li><p>zero-pointçš„é€‰æ‹©</p>
<p>  å› ä¸ºBNçš„å­˜åœ¨æ•°æ®åˆ†å¸ƒä¸ä¼šå¤ªç¦»è°±ï¼Œå¤§éƒ¨åˆ†é€‰æ‹© zero-pointå¯ä»¥è®¾ç½®ä¸º0ï¼Œè®¡ç®—æ›´å¿«ä¸”ä¸ä¼šæœ‰å¤§çš„æ€§èƒ½ drop, å¯å‚è€ƒ [<a target="_blank" rel="noopener" href="https://developer.download.nvidia.cn/video/gputechconf/gtc/2019/presentation/s9659-inference-at-reduced-precision-on-gpus.pdf">3</a>]. </p>
</li>
<li><p>scale çš„é€‰æ‹©</p>
<p>  ç®€å•ç²—æš´ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ s &#x3D; max(q_min.abs(), q_max.abs()) &#x2F; max(x)ã€‚ä½†æ˜¯å½“æ•°å€¼ç¦»ç¾¤ç‚¹æ¯”è¾ƒå¤šæ—¶ï¼Œè¿™ç§æ–¹æ³•å®¹æ˜“è®©é‡è¦æ•°å€¼æ²¡æœ‰åŒºåˆ†æ€§ã€‚</p>
<p>  æ›´å‡†ç¡®çš„æ˜¯å…ˆç»Ÿè®¡ç›´æ–¹å›¾ï¼Œå†é‡‡ç”¨ä¸åŒçš„æ–¹æ¡ˆè®¡ç®— â€œmax(x)â€: </p>
<ul>
<li><p>ä½¿ç”¨äº¤å‰ç†µæ¥ç»Ÿè®¡ </p>
<ol>
<li>å…ˆåˆ’åˆ†Nä¸ªbinså¯¹ floatæ•°æ®ç»Ÿè®¡ç»“æœ </li>
<li>éå†åŒºé—´, å¯¹æ¯”é‡‡ç”¨é‡åŒ–ç»Ÿè®¡ å¾—åˆ°çš„_pdfï¼Œä»¥åŠä¸ä½¿ç”¨é‡åŒ–å¾—åˆ°çš„çœŸå€¼pdf, è®¡ç®—äº¤å‰ç†µ</li>
<li>é€‰å–æœ€å°äº¤å‰ç†µæ‰€åœ¨çš„åŒºé—´çš„å³å€¼ï¼Œä½œä¸ºæœ€å¤§å€¼ amax ã€‚æ­¤æ—¶ scale &#x3D; max(q_min.abs(), q_max.abs()) &#x2F; amax</li>
</ol>
<p>  ç¤ºä¾‹ä»£ç å¦‚ä¸‹:<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">hist, bin_edges = np.histogram(x, bins=<span class="number">2000</span>, <span class="built_in">min</span>=x.<span class="built_in">min</span>, <span class="built_in">max</span>=x.<span class="built_in">max</span>)</span><br><span class="line">nbins = <span class="number">128</span> </span><br><span class="line">_pdf_count = np.zeros(nbins, dtype=np.float64)</span><br><span class="line">start =  <span class="number">1</span></span><br><span class="line">end = <span class="built_in">len</span>(hist) + <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end, stride)     </span><br><span class="line">    space = np.linspace(<span class="number">0</span>, i, num=nbins+<span class="number">1</span>)   </span><br><span class="line">    <span class="comment"># [0, i] mapping to [0, nbins] </span></span><br><span class="line">    digitized_space = np.digitize(<span class="built_in">range</span>(i), space) - <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">for</span> idx, digitized <span class="keyword">in</span> <span class="built_in">enumerate</span>(digitized_space):</span><br><span class="line">        _pdf_count[digitized] += hist[idx]</span><br><span class="line">    <span class="comment"># convert to prob</span></span><br><span class="line">    counter = Counter(digitized_space)</span><br><span class="line">    <span class="keyword">for</span> key, val <span class="keyword">in</span> counter.items():</span><br><span class="line">        _pdf_count[key] = _pdf_count[key] / val</span><br><span class="line">    _pdf = np.zeros(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, digitized <span class="keyword">in</span> <span class="built_in">enumerate</span>(digitized_space):</span><br><span class="line">        _pdf[idx] = _pdf_count[digitized]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># GT</span></span><br><span class="line">    pdf = np.array(hist[:<span class="built_in">len</span>(digitized_space)])</span><br><span class="line">    pdf[-<span class="number">1</span>] += np.<span class="built_in">sum</span>(hist[i:])</span><br><span class="line">    pdf /= <span class="built_in">sum</span>(pdf)  <span class="comment"># normalize</span></span><br><span class="line">    ent = entropy(pdf, _pdf)</span><br><span class="line">Get minimum ent <span class="keyword">and</span> its index</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>ä½¿ç”¨MSEçš„æ–¹å¼</p>
<p>  å’Œäº¤å‰ç†µéƒ½éœ€è¦éå†åŒºé—´ï¼Œä½†æ˜¯ä½¿ç”¨æœ€å°åŒ–é‡åŒ–ä¸­å¿ƒç‚¹çš„æ–¹å¼ã€‚å¦‚æœæ•°æ®æ˜¯å¯¹ç§°åˆ†å¸ƒçš„æƒ…å†µä¼šç®—çš„æ›´å‡†ã€‚</p>
<p>  ç¤ºä¾‹ä»£ç å¦‚ä¸‹: </p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hist, bin_edges = np.histogram(x, bins=2000, min=x.min, max=x.max)</span><br><span class="line">centers = (bin_edges[1:] + bin_edges[:-1]) / 2</span><br><span class="line">start =  1</span><br><span class="line">end = len(hist) + 1</span><br><span class="line">for i in range(start, end, stride):</span><br><span class="line">    # try to quant and get quant centers</span><br><span class="line">    amax = centers[i]</span><br><span class="line">    quant_centers = quant_tensor(centers, amax, num_bits, unsigned)</span><br><span class="line">    mse = ((quant_centers - centers)**2 * counts).mean()</span><br><span class="line">Get minium mse and its index.</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨ç™¾åˆ†æ¯”çš„æ–¹å¼</p>
<p>  è®¡ç®—ç›´æ–¹å›¾çš„ cdf, å¾—åˆ°èƒ½å¤ŸåŒ…å« K% æ•°æ®æœ€å¤§çš„ index</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hist, bin_edges = np.histogram(x, bins=2000, min=x.min, max=x.max)</span><br><span class="line">total = hist.sum()</span><br><span class="line">cdf = np.cumsum(hist / total) </span><br><span class="line">idx = np.searchsorted(cdf, K / 100)</span><br><span class="line">amax = bin_edges[idx]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>  å¯¹äºç‰¹æ®Šçš„æ•°æ®åˆ†å¸ƒï¼Œå¯èƒ½æœ‰ä¸€äº›ç‰¹å®šçš„æ–¹æ³•æ¥å®ç°ã€‚</p>
</li>
<li><p>$q_{min}$, $q_{max}$ </p>
<p>  é€šå¸¸ä½¿ç”¨ [-127, 127] æˆ–è€… [-128, 127]ã€‚</p>
<p>  å¦‚æœå¯¹äº <code> s = max(q_min.abs(), q_max.abs()) / max(x)</code> çš„æƒ…å†µï¼Œåè€…ä¼šåœ¨å¯¹ç§°åˆ†å¸ƒçš„æƒ…å†µä¼šå¼•å…¥ä¸€äº›bias [<a target="_blank" rel="noopener" href="https://developer.download.nvidia.cn/video/gputechconf/gtc/2019/presentation/s9659-inference-at-reduced-precision-on-gpus.pdf">3</a>]ã€‚æ­¤æ—¶å¯ä»¥ä¿®æ”¹åŒºé—´å¤§å°ã€‚</p>
</li>
</ul>
<p>é‚£ä¹ˆï¼Œé‡åŒ–å¦‚ä½•åœ¨å·ç§¯ä¸­åŠ é€Ÿå‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæ¥çœ‹å·ç§¯çš„æ“ä½œ, æˆ‘ä»¬ç”¨ $y &#x3D; conv(w, x)$ æ¥è¡¨ç¤ºåŸå§‹å·ç§¯ï¼Œå·ç§¯çš„è¿ç®—æ»¡è¶³</p>
<ul>
<li>$y &#x3D; conv(w-a, x) &#x3D; conv(w, x) - conv(a, x) &#x3D; conv(w, x) - k$, kæ˜¯ä¸ªå¸¸æ•°</li>
<li>$y &#x3D; conv(a<em>w , b</em>x) &#x3D; a * b * conv(w, x)$</li>
</ul>
<p>$y &#x3D; conv(w, x) ~&#x3D; conv(w_{DQ}, x_{DQ}) &#x3D; conv((w_{Q} - w_{z}) * w_{scale}, (x_{Q} - x_{z}) * x_{scale}) $ </p>
<p>$  &#x3D; w_{scale} * x_{scale} ( conv(w_{Q}, x_{Q}) - conv(w_{Q},x_z) - conv(w_z, x_{Q}) + conv(w_z, x_z)) $</p>
<p>åä¸‰é¡¹çš„å·ç§¯éƒ½æ˜¯å¸¦å¸¸æ•°çš„ï¼Œå¯ä»¥ç”¨åŠ æ³•æ¥è§£å†³ã€‚ å¦‚æœ $x_z, w_z$ éƒ½è®¾ç½®0ï¼Œä»–ä»¬å°±å®Œç¾æ¶ˆå¤±äº†ã€‚</p>
<p>è‡³äº $conv(w_{Q}, x_{Q}$çš„å®ç°ï¼Œ æˆ‘ä»¬å¯ä»¥ä¼˜åŒ– gemm kernelçš„æ¥å®ç°ï¼Œ è¿™ä¸ªæ•…äº‹å¯å°±å¤ªé•¿äº†ï¼Œå¯ä»¥ç®€å•çš„æ„Ÿå—ä¸€ä¸‹cublasçš„ int8 ç‰ˆæœ¬å¿«å¤šå°‘ã€‚</p>
<ul>
<li><p>cublas_kernel_dtype.cu</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cublas_v2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> USE_INT8</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> message(<span class="string">&quot;use INT8&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> mt = <span class="type">char</span>;</span><br><span class="line"><span class="keyword">using</span> rt = <span class="type">int</span>;</span><br><span class="line"><span class="keyword">using</span> st = <span class="type">int</span>;</span><br><span class="line">cudaDataType   Atype = CUDA_R_8I;</span><br><span class="line">cudaDataType   Ctype = CUDA_R_32I;</span><br><span class="line">cublasComputeType_t   computeType = CUBLAS_COMPUTE_32I;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> USE_FP16</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> message(<span class="string">&quot;use FP16&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_fp16.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> mt = half;</span><br><span class="line"><span class="keyword">using</span> rt = half;</span><br><span class="line"><span class="keyword">using</span> st = half;</span><br><span class="line">cudaDataType   Atype = CUDA_R_16F;</span><br><span class="line">cudaDataType   Ctype = CUDA_R_16F;</span><br><span class="line">cublasComputeType_t   computeType = CUBLAS_COMPUTE_16F;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">// using FP32</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> message(<span class="string">&quot;use FP32&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> mt = <span class="type">float</span>;</span><br><span class="line"><span class="keyword">using</span> rt = <span class="type">float</span>;</span><br><span class="line"><span class="keyword">using</span> st = <span class="type">float</span>;</span><br><span class="line">cudaDataType   Atype = CUDA_R_32F;</span><br><span class="line">cudaDataType   Ctype = CUDA_R_32F;</span><br><span class="line">cublasComputeType_t   computeType = CUBLAS_COMPUTE_32F;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> dim = <span class="number">4096</span>;</span><br><span class="line"><span class="type">int</span> m = dim;</span><br><span class="line"><span class="type">int</span> n = dim;</span><br><span class="line"><span class="type">int</span> k = dim;</span><br><span class="line">mt *A, *B;</span><br><span class="line">rt *C;</span><br><span class="line"><span class="built_in">cudaMalloc</span>(&amp;A, <span class="built_in">sizeof</span>(A[<span class="number">0</span>])*m*k);</span><br><span class="line"><span class="built_in">cudaMalloc</span>(&amp;B, <span class="built_in">sizeof</span>(B[<span class="number">0</span>])*n*k);</span><br><span class="line"><span class="built_in">cudaMalloc</span>(&amp;C, <span class="built_in">sizeof</span>(C[<span class="number">0</span>])*m*n);</span><br><span class="line">st alpha = <span class="number">1</span>;</span><br><span class="line">st beta = <span class="number">0</span>;</span><br><span class="line">cublasHandle_t h;</span><br><span class="line">cublasStatus_t stat = <span class="built_in">cublasCreate</span>(&amp;h);</span><br><span class="line">stat = <span class="built_in">cublasGemmEx</span>(h,</span><br><span class="line">                    CUBLAS_OP_T,</span><br><span class="line">                    CUBLAS_OP_N,</span><br><span class="line">                    m,</span><br><span class="line">                    n,</span><br><span class="line">                    k,</span><br><span class="line">                    &amp;alpha,</span><br><span class="line">                    A,</span><br><span class="line">                    Atype,</span><br><span class="line">                    dim,</span><br><span class="line">                    B,</span><br><span class="line">                    Atype,</span><br><span class="line">                    dim,</span><br><span class="line">                    &amp;beta,</span><br><span class="line">                    C,</span><br><span class="line">                    Ctype,</span><br><span class="line">                    dim,</span><br><span class="line">                    computeType,</span><br><span class="line">                    CUBLAS_GEMM_DEFAULT);</span><br><span class="line">std::cout &lt;&lt; (<span class="type">int</span>)stat &lt;&lt; std::endl;</span><br><span class="line"><span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">cudaError_t err = <span class="built_in">cudaGetLastError</span>();</span><br><span class="line">std::cout &lt;&lt; <span class="built_in">cudaGetErrorString</span>(err) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>compile</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nvcc cublas_kernel_dtype.cu -o test_fp32 -DUSE_FP32 -lcublas</span><br><span class="line">nvcc cublas_kernel_dtype.cu -o test_fp16 -DUSE_FP16 -lcublas</span><br><span class="line">nvcc cublas_kernel_dtype.cu -o test_int8 -DUSE_INT8 -lcublas</span><br><span class="line"></span><br><span class="line">nsys nvprof --print-gpu-trace ./test_int8</span><br><span class="line">nsys nvprof --print-gpu-trace ./test_fp16</span><br><span class="line">nsys nvprof --print-gpu-trace ./test_fp32</span><br><span class="line"></span><br><span class="line"># kernel time run ONCE</span><br><span class="line"># 26.81ms 3.2ms 2ms</span><br><span class="line"># kernel name</span><br><span class="line"># ampere_sgemm_128x32_tn  ampere_h16816gemm_128x128_ldg8_stages_32x5_tn  cutlass::Kernel&lt;cutlass_80_tensorop_i16832gemm_s8_128x64_128x3_tn_align16&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2><span id="é‡åŒ–åˆ†ç±»">é‡åŒ–åˆ†ç±»</span><a href="#é‡åŒ–åˆ†ç±»" class="header-anchor"> ğŸ”—</a></h2><ul>
<li><p>éå‡åŒ€</p>
<p>  åœ¨ä¸Šé¢çš„ä»‹ç»é‡Œï¼Œæˆ‘ä»¬å¯¹å®šç‚¹æ•°çš„è½¬æ¢éƒ½æ˜¯éƒ½æ˜¯å‡åŒ€çš„ï¼Œä¸ºäº†è®©æ•°æ®å…·æœ‰åŒºåˆ†æ€§ä¸€äº›æ–¹æ¡ˆä¹Ÿä¼šç”¨éå‡åŒ€çš„æ˜ å°„ã€‚è¿™ç§æ–¹å¼ä¹Ÿä¼šå¸¦æ¥æ›´å¤šçš„è®¡ç®—é‡ï¼Œå·¥ç¨‹ä¸Šï¼ˆä»¥åŠæˆ‘ï¼‰å¹¶ä¸å–œæ¬¢è¿™ç§æ–¹æ¡ˆã€‚  </p>
</li>
<li><p>å®šç‚¹é‡åŒ–</p>
<p>  åœ¨é€‰å– scale çš„æ—¶å€™æ˜¯ 1 &#x2F; 2^N, è¿™æ ·Q&#x2F;DQè¿‡ç¨‹å¯ä»¥ç”¨ç§»ä½æ¥æ›´å¿«çš„å®ç°ï¼ˆåœ¨ç¡¬ä»¶æ”¯æŒçš„åŸºç¡€ä¸Šï¼‰</p>
</li>
<li><p>è®­ç»ƒåé‡åŒ– (post-training quantization, PTQ)</p>
<p>  è®­ç»ƒåå¯¹æƒé‡é‡æ–°ç»Ÿè®¡ï¼Œç›´æ¥ç”¨ int8 çš„kernelè®¡ç®—å³å¯ã€‚å¦‚æœç»Ÿè®¡å‘ç”Ÿåœ¨å›¾èåˆä¹‹å‰ï¼Œé‡åŒ–å‚æ•°éœ€è¦å¯¹åº”ä¿®æ”¹ã€‚</p>
</li>
<li><p>è®­ç»ƒæ—¶é‡åŒ– (quantization-aware training QAT)</p>
<p>  é€šå¸¸ä¼šåœ¨è®­ç»ƒåé‡åŒ–æ‰ç‚¹åï¼Œå¼•å…¥è®­ç»ƒæ—¶é‡åŒ–ã€‚è¿™æ ·å¯ä»¥åœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œé˜²æ­¢æ•°å€¼åˆ†å¸ƒå¤ªç¦»è°±ã€‚ä¿æŒè®­ç»ƒç¨³å®šçš„trickå¯ä»¥å‚è€ƒ[<a target="_blank" rel="noopener" href="https://developer.download.nvidia.cn/video/gputechconf/gtc/2019/presentation/s9659-inference-at-reduced-precision-on-gpus.pdf">3</a>]. è¿™é‡Œåªè¯´ä¸€ä¸‹ç»“è®º</p>
<ul>
<li>EMA éœ€è¦å°å¿ƒä½¿ç”¨</li>
<li>å¯¹BNéœ€è¦ç‰¹æ®Šå¯¹å¾…</li>
<li>æ¨¡å‹å­˜åœ¨ size &amp; å¯å‹ç¼©æ€§çš„ trade-off, å› ä¸ºå¤§æ¨¡å‹å¯¹å™ªå£°çš„å®¹å¿åº¦æ¯”è¾ƒé«˜</li>
<li>distill å¯ä»¥å¸®åŠ©æé«˜é‡åŒ–è®­ç»ƒæ€§èƒ½</li>
<li>æ­£åˆ™åŒ–æœ‰åŠ©äºå‡å°weightsçš„range, å¯ä»¥å‡å°é‡åŒ–éš¾åº¦</li>
</ul>
</li>
</ul>
<h2><span id="ptq">PTQ</span><a href="#ptq" class="header-anchor"> ğŸ”—</a></h2><h3><span id="å’Œè®¡ç®—å›¾">å’Œè®¡ç®—å›¾</span><a href="#å’Œè®¡ç®—å›¾" class="header-anchor"> ğŸ”—</a></h3><h3><span id="å’Œllm">å’ŒLLM</span><a href="#å’Œllm" class="header-anchor"> ğŸ”—</a></h3><p>LLMçš„éƒ¨ç½²é‡åŒ–å¯ä»¥å¤§å¹…åº¦å‡å°‘æˆæœ¬ï¼ŒåŠ å¿«é€Ÿåº¦ã€‚æ¯”å¦‚ [LLAMA.cpp]</p>
<h2><span id="qat-çš„ä¸€äº›è¿›å±•">QAT çš„ä¸€äº›è¿›å±•</span><a href="#qat-çš„ä¸€äº›è¿›å±•" class="header-anchor"> ğŸ”—</a></h2><h3><span id></span><a href="#" class="header-anchor"> ğŸ”—</a></h3><h2><span id="å‚è€ƒ">å‚è€ƒ</span><a href="#å‚è€ƒ" class="header-anchor"> ğŸ”—</a></h2><ol>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/tensorflow-quantization-toolkit/docs/docs/intro_to_quantization.html">https://docs.nvidia.com/deeplearning/tensorrt/tensorflow-quantization-toolkit/docs/docs/intro_to_quantization.html</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1806.08342.pdf">https://arxiv.org/pdf/1806.08342.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.download.nvidia.cn/video/gputechconf/gtc/2019/presentation/s9659-inference-at-reduced-precision-on-gpus.pdf">https://developer.download.nvidia.cn/video/gputechconf/gtc/2019/presentation/s9659-inference-at-reduced-precision-on-gpus.pdf</a></li>
</ol>
<p>[LLAMA.cpp]:</p>

                        
          </div>
          <footer class="article-footer">
            <a data-url="http://licharyuan.github.io/2023/07/29/quant-note-md/" data-id="clknsk5qb0000q1cbebz80xkt" class="article-share-link">Share</a>
            
                
          </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/07/26/tools-collections/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Tools Collections</div>
    </a>
  
</nav>

      
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/07/29/quant-note-md/">é‡åŒ–ç¬”è®°</a>
          </li>
        
          <li>
            <a href="/2023/07/26/tools-collections/">Tools Collections</a>
          </li>
        
          <li>
            <a href="/2023/04/16/Hexo-collections/">Hexo èµ„æ–™æ±‡æ€»</a>
          </li>
        
          <li>
            <a href="/2023/03/03/NeRF-survey/">NeRF Survey</a>
          </li>
        
          <li>
            <a href="/2023/02/15/Shell-note/">Shell åˆçº§ç¬”è®°</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Code/">Code</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Papers/">Papers</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/3D/" rel="tag">3D</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NeRF/" rel="tag">NeRF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/" rel="tag">note</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 lichar<br>
      
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">ä¸»é¡µ</a>
  
    <a href="/about" class="mobile-nav-link">å…³äº</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<div id="scroll2top" style="position:fixed;bottom:150px;right:50px;cursor: pointer;Z-index:9999">
<a title="è¿”å›é¡¶éƒ¨" href="#"><img src="/scroll2top/scrollup.png"/></a>
</div>
<script src="/scroll2top/scroll2top.js"></script>



  </div>
</body>
</html>